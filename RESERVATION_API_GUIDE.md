# üé´ Guide API de R√©servation Simplifi√©e

## üìã **Endpoint Principal**
```
POST /api/v1/tickets/simple/reserve
```

## üîê **Authentification**
- **Token Bearer** requis dans le header
- Utilisateur doit √™tre connect√©

## üìù **Structure de la Requ√™te**

### **Champs Obligatoires (Toujours)**
```json
{
  "tickets": [
    {
      "ticket_id": 1,
      "quantity": 2
    }
  ]
}
```

### **Champs Optionnels (Selon le Type de Ticket)**
```json
{
  "telephone": "243826785727",         // REQUIS pour mobile_money
  "payment_method": "mobile_money",    // mobile_money OU card (requis si payant)
  "payment_currency": "USD"            // USD OU CDF (requis si payant)
}
```

## üéØ **R√®gles de Validation**

### **‚úÖ Tickets Gratuits (0 CDF)**
- **Aucun champ de paiement requis**
- **T√©l√©phone optionnel**
- R√©servation imm√©diate

### **üí∞ Tickets Payants (> 0 CDF)**
- **`payment_method` OBLIGATOIRE** : `mobile_money` ou `card`
- **`payment_currency` OBLIGATOIRE** : 
  - `USD` ou `CDF` pour `mobile_money`
  - `USD` uniquement pour `card`
- **`telephone` OBLIGATOIRE** : Seulement si `payment_method = "mobile_money"`

## üì± **Exemples d'Utilisation**

### **1. R√©servation Gratuite**
```json
POST /api/v1/tickets/simple/reserve
{
  "tickets": [
    {"ticket_id": 2, "quantity": 1}
  ]
}
```

### **2. R√©servation Payante - Mobile Money USD**
```json
POST /api/v1/tickets/simple/reserve
{
  "tickets": [
    {"ticket_id": 4, "quantity": 1}
  ],
      "telephone": "243826785727",
    "payment_method": "mobile_money",
    "payment_currency": "USD" /// or CDF
}
```

### **3. R√©servation Payante - Carte USD**
```json
POST /api/v1/tickets/simple/reserve
{
  "tickets": [
    {"ticket_id": 4, "quantity": 1}
  ],
  "payment_method": "card",
  "payment_currency": "USD"
}
```

## üîÑ **R√©ponses de l'API par Type de R√©servation**

### **‚úÖ Succ√®s - R√©servation Gratuite**
```json
{
  "success": true,
  "message": "R√©servation gratuite confirm√©e",
  "data": {
    "reservation_id": "RES_123456",
    "participants": [
      {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com",
        "phone": "243826785727",
        "ticket_type": "GRATUIT",
        "qr_code": "qr_code_123.png",
        "status": "confirmed"
      }
    ],
    "total_amount": 0,
    "currency": "CDF",
    "payment_method": "free",
    "payment_status": "completed",
    "event": {
      "id": 1,
      "name": "Concert Test FlexPay",
      "date": "2024-12-31",
      "location": "Kinshasa"
    },
    "tickets": [
      {
        "ticket_id": 2,
        "type": "GRATUIT",
        "quantity": 1,
        "price": 0,
        "currency": "CDF"
      }
    ],
    "created_at": "2024-08-27T00:00:00.000000Z"
  }
}
```

### **‚úÖ Succ√®s - R√©servation Mobile Money**
```json
{
  "success": true,
  "message": "Redirection vers le paiement mobile money",
  "data": {
    "payment_type": "mobile_money",
    "payment_url": null,
    "business_reference": "MM_123456",
    "amount": 25500,
    "currency": "USD",
    "phone": "243826785727",
    "payment_status": "pending",
    "flexpay_response": {
      "code": "0",
      "message": "Transaction initi√©e avec succ√®s",
      "orderNumber": "FlexPay_123456",
      "transaction": {
        "channel": "airtel_money",
        "status": "pending"
      }
    },
    "event": {
      "id": 1,
      "name": "Concert Test FlexPay",
      "date": "2024-12-31",
      "location": "Kinshasa"
    },
    "tickets": [
      {
        "ticket_id": 4,
        "type": "VIP USD",
        "quantity": 1,
        "price": 25.50,
        "currency": "USD"
      }
    ],
    "participants": [
      {
        "id": 2,
        "name": "John Doe",
        "email": "john@example.com",
        "phone": "243826785727",
        "ticket_type": "VIP USD",
        "qr_code": "qr_code_124.png",
        "status": "pending_payment"
      }
    ],
    "created_at": "2024-08-27T00:00:00.000000Z"
  }
}
```

### **‚úÖ Succ√®s - R√©servation par Carte**
```json
{
  "success": true,
  "message": "Redirection vers le paiement par carte",
  "data": {
    "payment_type": "card",
    "payment_url": "https://cardpayment.flexpay.cd/v2/pay/...",
    "business_reference": "MM_123457",
    "amount": 25.50,
    "currency": "USD",
    "payment_status": "pending",
    "flexpay_response": {
      "code": "0",
      "message": "Redirection en cours",
      "orderNumber": "LeR4frf045091721",
      "url": "https://cardpayment.flexpay.cd/v2/pay/..."
    },
    "event": {
      "id": 1,
      "name": "Concert Test FlexPay",
      "date": "2024-12-31",
      "location": "Kinshasa"
    },
    "tickets": [
      {
        "ticket_id": 4,
        "type": "VIP USD",
        "quantity": 1,
        "price": 25.50,
        "currency": "USD"
      }
    ],
    "participants": [
      {
        "id": 3,
        "name": "John Doe",
        "email": "john@example.com",
        "phone": null,
        "ticket_type": "VIP USD",
        "qr_code": "qr_code_125.png",
        "status": "pending_payment"
      }
    ],
    "created_at": "2024-08-27T00:00:00.000000Z"
  }
}
```

### **‚ùå Erreur - Champs Manquants**
```json
{
  "success": false,
  "message": "Devise de paiement requise pour les tickets payants. Devises support√©es: USD, CDF",
  "error_code": "PAYMENT_CURRENCY_REQUIRED",
  "details": {
    "missing_field": "payment_currency",
    "required_for": "paid_tickets",
    "supported_currencies": ["USD", "CDF"]
  }
}
```

## üìä **Codes de Statut et Messages d'Erreur**

### **üü¢ Codes de Succ√®s (200)**
| Code | Message | Description |
|------|---------|-------------|
| `RESERVATION_FREE_CONFIRMED` | R√©servation gratuite confirm√©e | Ticket gratuit r√©serv√© imm√©diatement |
| `MOBILE_PAYMENT_INITIATED` | Paiement mobile money initi√© | Transaction FlexPay en cours |
| `CARD_PAYMENT_REDIRECT` | Redirection vers le paiement par carte | URL de paiement g√©n√©r√©e |

### **üî¥ Codes d'Erreur (400/422)**
| Code | Message | Description |
|------|---------|-------------|
| `VALIDATION_ERROR` | Donn√©es de r√©servation invalides | Erreur de validation des champs |
| `PAYMENT_METHOD_REQUIRED` | M√©thode de paiement requise | `payment_method` manquant pour tickets payants |
| `PAYMENT_CURRENCY_REQUIRED` | Devise de paiement requise | `payment_currency` manquant pour tickets payants |
| `PHONE_REQUIRED_MOBILE` | T√©l√©phone requis pour mobile money | `telephone` manquant pour mobile money |
| `CARD_USD_ONLY` | Carte uniquement en USD | Tentative de paiement par carte en CDF |
| `INVALID_PAYMENT_METHOD` | M√©thode de paiement invalide | Valeur non support√©e |
| `INVALID_CURRENCY` | Devise de paiement invalide | Valeur non support√©e |
| `INVALID_PHONE_FORMAT` | Format de t√©l√©phone invalide | Format 243XXXXXXXXX requis |

## üö® **Messages d'Erreur Courants**

| Erreur | Cause | Solution |
|--------|-------|----------|
| `M√©thode de paiement requise` | Ticket payant sans m√©thode | Ajouter `payment_method` |
| `Devise de paiement requise` | Ticket payant sans devise | Ajouter `payment_currency` |
| `Num√©ro de t√©l√©phone requis` | Mobile money sans t√©l√©phone | Ajouter `telephone` |
| `Format de t√©l√©phone invalide` | Format incorrect | Utiliser `243XXXXXXXXX` |
| `M√©thode de paiement invalide` | Valeur incorrecte | Utiliser `mobile_money` ou `card` |
| `Devise de paiement invalide` | Valeur incorrecte | Utiliser `USD` ou `CDF` |
| `Le paiement par carte est uniquement support√© en USD` | Carte avec devise CDF | Utiliser `USD` pour les cartes |

## üí° **Bonnes Pratiques Front-End**

### **1. Validation Intelligente**
```javascript
// V√©rifier si des tickets sont payants
const hasPaidTickets = tickets.some(ticket => ticket.price > 0);

if (hasPaidTickets) {
  // Afficher les champs payment_method et payment_currency
  showPaymentFields();
  
  // Afficher le t√©l√©phone seulement pour mobile money
  showPhoneField();
} else {
  // Masquer tous les champs de paiement
  hidePaymentFields();
  hidePhoneField();
}

// G√©rer la restriction devise pour les cartes
const handlePaymentMethodChange = (method) => {
  if (method === 'card') {
    // Forcer USD pour les cartes
    setPaymentCurrency('USD');
    // D√©sactiver le s√©lecteur de devise
    disableCurrencySelector();
  } else {
    // R√©activer le s√©lecteur de devise pour mobile money
    enableCurrencySelector();
  }
};
```

### **2. Gestion des √âtats**
```javascript
const [formData, setFormData] = useState({
  tickets: [],
  telephone: '',
  payment_method: '',
  payment_currency: ''
});

// Mettre √† jour dynamiquement selon le type de ticket
useEffect(() => {
  const hasPaidTickets = formData.tickets.some(t => t.price > 0);
  if (!hasPaidTickets) {
    setFormData(prev => ({
      ...prev,
      payment_method: '',
      payment_currency: '',
      telephone: ''
    }));
  }
}, [formData.tickets]);

// G√©rer l'affichage du t√©l√©phone selon la m√©thode de paiement
useEffect(() => {
  if (formData.payment_method === 'mobile_money') {
    showPhoneField();
  } else {
    hidePhoneField();
    setFormData(prev => ({ ...prev, telephone: '' }));
  }
}, [formData.payment_method]);
```

### **3. Messages d'Erreur Contextuels**
```javascript
const getErrorMessage = (error) => {
  if (error.includes('M√©thode de paiement requise')) {
    return 'Veuillez s√©lectionner une m√©thode de paiement';
  }
  if (error.includes('Devise de paiement requise')) {
    return 'Veuillez s√©lectionner une devise de paiement';
  }
  if (error.includes('Num√©ro de t√©l√©phone requis')) {
    return 'Veuillez saisir votre num√©ro de t√©l√©phone pour le paiement mobile money';
  }
  if (error.includes('Format de t√©l√©phone invalide')) {
    return 'Format de t√©l√©phone incorrect. Utilisez le format: 243XXXXXXXXX';
  }
  return error;
};
```

## üîó **Endpoints Compl√©mentaires**

### **V√©rifier la Disponibilit√©**
```
GET /api/v1/tickets/simple/check-availability?ticket_id=1&quantity=2
```

### **Informations du Ticket**
```
GET /api/v1/tickets/simple/info/{ticketId}
```

### **Statut du Paiement**
```
GET /api/v1/tickets/check-flexpay-status/{businessReference}
```

## üí≥ **Paiement par Carte FlexPay**

### **M√©thodes Support√©es**
- **Visa** : Cartes Visa internationales
- **MasterCard** : Cartes MasterCard internationales

### **‚ö†Ô∏è Restriction Importante**
- **Devise unique** : Le paiement par carte est **uniquement support√© en USD**
- **Mobile money** : Supporte USD et CDF

### **Processus de Paiement**
1. **G√©n√©ration de l'URL** : FlexPay g√©n√®re une URL s√©curis√©e
2. **Redirection** : L'utilisateur est redirig√© vers la page de paiement
3. **Paiement** : L'utilisateur saisit ses informations de carte
4. **Confirmation** : Le statut est confirm√© automatiquement



## üì± **Support Mobile Money**

### **Num√©ros de Test FlexPay**
- **Airtel Money** : `243826785727`
- **M-Pesa** : `243826785727`
- **Orange Money** : `243826785727`

### **Montants de Test**
- **CDF** : Minimum 100 CDF
- **USD** : Minimum 0.10 USD

## üé® **Interface Utilisateur Recommand√©e**

### **1. S√©lection des Tickets**
- Liste des tickets disponibles
- Prix affich√© en devise du ticket
- S√©lecteur de quantit√©

### **2. Champs de Paiement (Conditionnels)**
- **M√©thode** : Boutons radio `mobile_money` / `card`
- **Devise** : Boutons radio `USD` / `CDF`
- Affichage conditionnel selon le type de ticket

### **3. Validation en Temps R√©el**
- V√©rification des champs requis
- Messages d'erreur contextuels
- Bouton de soumission activ√©/d√©sactiv√©

---

## üß™ **Tests d'Int√©gration**

### **üì± Test Mobile Money**
```bash
# Test de r√©servation mobile money
curl -X POST /api/v1/tickets/simple/reserve \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "tickets": [{"ticket_id": 4, "quantity": 1}],
    "telephone": "243826785727",
    "payment_method": "mobile_money",
    "payment_currency": "USD"
  }'
```

### **üí≥ Test Paiement par Carte**
```bash
# Test de r√©servation par carte
curl -X POST /api/v1/tickets/simple/reserve \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "tickets": [{"ticket_id": 4, "quantity": 1}],
    "payment_method": "card",
    "payment_currency": "USD"
  }'
```

### **üé´ Test R√©servation Gratuite**
```bash
# Test de r√©servation gratuite
curl -X POST /api/v1/tickets/simple/reserve \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "tickets": [{"ticket_id": 2, "quantity": 1}]
  }'
```

## ‚ÑπÔ∏è **Note Technique**

> **üí° Le back-end g√®re automatiquement tous les callbacks FlexPay.**
> 
> - Les notifications de paiement sont trait√©es en arri√®re-plan
> - Le statut des r√©servations est mis √† jour automatiquement
> - Aucune action suppl√©mentaire n'est requise c√¥t√© front-end

## üöÄ **Pr√™t √† Impl√©menter !**

Cette API simplifi√©e permet de g√©rer facilement les r√©servations avec une validation intelligente et une exp√©rience utilisateur optimale.

**Questions ?** Consultez les logs du serveur pour plus de d√©tails sur le traitement.
